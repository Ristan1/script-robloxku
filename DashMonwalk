-- [[ Layanan & Player Lokal ]]
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CollectionService = game:GetService("CollectionService")
local Debris = game:GetService("Debris")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local TextService = game:GetService("TextService") 
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

-- [[ Variabel Status & Loop ]]
local moonwalkActive = false
local dashCooldown = false
local originalTransparencies = {} 
local effectsFolder 
local dashAfterimageConnection
local dashCooldownConnection
local moonwalkConnection
local isScriptEnabled = false 

-- [[ Konfigurasi ]]
-- Dash
local DASH_POWER = 70
local DASH_DURATION = 0.2
local COOLDOWN_TIME = 1
local DASH_ANIMATION_ID = "rbxassetid://7990625013"
local DASH_SOUND_ID = "rbxassetid://122283352809655"
-- Efek Afterimage
local AFTERIMAGE_TRANSPARENCY = 0.5
local AFTERIMAGE_LIFETIME = 2
local AFTERIMAGE_INTERVAL = 0.03
local SANDEVISTAN_COLORS = {
    Color3.fromRGB(0, 115, 115), Color3.fromRGB(77, 0, 115), Color3.fromRGB(115, 0, 0),
    Color3.fromRGB(115, 115, 0), Color3.fromRGB(0, 115, 0)
}
local MAX_AFTERIMAGES = 20
local VERTICAL_OFFSET = 5
-- GUI
local BUTTON_SIZE = UDim2.new(0, 45, 0, 45)             
-- >> PERUBAHAN: Mengambil posisi dari script dash yang disediakan: (0, 651, 0, 250)
local BUTTON_POSITION = UDim2.new(0, 651, 0, 250) 
local DASH_COLOR = Color3.fromRGB(85, 0, 128)
local MENU_BUTTON_SIZE = UDim2.new(0, 40, 0, 40)
local MENU_BUTTON_POSITION = UDim2.new(0.5, 0, 1, -80) -- Posisi tombol pengaturan (tengah bawah)
local MENU_ITEM_GAP = 20 
local MENU_BUTTON_HEIGHT = 50 
local PADDING_X = 40 

-- ====================================================================
--                         LOGIKA EFEK & FUNGSI INTI
-- ====================================================================

local function getEffectsFolder()
    if not effectsFolder or not effectsFolder.Parent then
        effectsFolder = Instance.new("Folder")
        effectsFolder.Name = "ScriptEffects"
        effectsFolder.Parent = workspace
    end
    return effectsFolder
end

local function toggleCharacterVisibility(character, isVisible)
    if isVisible then
        for part, transparency in pairs(originalTransparencies) do
            if part and part.Parent then part.Transparency = transparency end
        end
        originalTransparencies = {}
    else
        originalTransparencies = {}
        for _, part in pairs(character:GetDescendants()) do
            if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
                originalTransparencies[part] = part.Transparency
                part.Transparency = 1
            end
        end
    end
end

local function getGradientColor(index, total)
    index = total - index + 1
    local colorCount = #SANDEVISTAN_COLORS
    local position = ((index-1) / (total-1)) * (colorCount-1)
    local colorIndex = math.floor(position) + 1
    local nextColorIndex = math.min(colorIndex + 1, colorCount)
    local lerpAmount = position - math.floor(position)
    local color1 = SANDEVISTAN_COLORS[colorIndex]
    local color2 = SANDEVISTAN_COLORS[nextColorIndex]
    return color1:Lerp(color2, lerpAmount)
end

local function createAfterimage(character, afterimageCount)
    local clone = Instance.new("Model", getEffectsFolder())
    clone.Name = "DashAfterimage"
    local rootPart = character.HumanoidRootPart
    if not rootPart then clone:Destroy() return end
    
    for _, part in pairs(character:GetDescendants()) do
        if part:IsA("BasePart") and (originalTransparencies[part] or part.Transparency) < 1 then
            local clonePart = part:Clone()
            clonePart:ClearAllChildren()
            clonePart.CanCollide, clonePart.CanQuery, clonePart.CanTouch, clonePart.Anchored = false, false, false, true
            clonePart.Material = Enum.Material.Neon
            clonePart.Color = getGradientColor(afterimageCount, MAX_AFTERIMAGES)
            clonePart.Transparency = AFTERIMAGE_TRANSPARENCY
            clonePart.CFrame = part.CFrame
            clonePart.Parent = clone
            CollectionService:AddTag(clonePart, "ScriptEffect")
        end
    end
    
    if #clone:GetChildren() > 0 then
        Debris:AddItem(clone, AFTERIMAGE_LIFETIME)
        local startTime = tick()
        local connection = RunService.Heartbeat:Connect(function()
            local elapsed = tick() - startTime
            if elapsed >= AFTERIMAGE_LIFETIME then connection:Disconnect() return end
            local fade = elapsed / AFTERIMAGE_LIFETIME
            for _, p in pairs(clone:GetChildren()) do p.Transparency = AFTERIMAGE_TRANSPARENCY + (1 - AFTERIMAGE_TRANSPARENCY) * fade end
        end)
    else
        clone:Destroy()
    end
end

local function doDash()
    if not isScriptEnabled or dashCooldown then return end
    local char = LocalPlayer.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    local humanoid = char and char:FindFirstChild("Humanoid")
    if not hrp or not humanoid then return end
    
    dashCooldown = true
    
    toggleCharacterVisibility(char, false)
    
    local lastAfterimage = 0
    local afterimageCount = 0
    dashAfterimageConnection = RunService.Heartbeat:Connect(function()
        if tick() - lastAfterimage >= AFTERIMAGE_INTERVAL then
            afterimageCount = (afterimageCount % MAX_AFTERIMAGES) + 1
            createAfterimage(char, afterimageCount)
            lastAfterimage = tick()
        end
    end)
    
    local anim = Instance.new("Animation", humanoid) anim.AnimationId = DASH_ANIMATION_ID
    local track = humanoid.Animator:LoadAnimation(anim) track:Play()
    
    local sound = Instance.new("Sound", hrp) sound.SoundId = DASH_SOUND_ID sound:Play()
    Debris:AddItem(sound, 3)

    local bv = Instance.new("BodyVelocity", hrp)
    bv.Velocity = hrp.CFrame.LookVector * DASH_POWER + Vector3.new(0, VERTICAL_OFFSET, 0)
    bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
    
    humanoid:ChangeState(Enum.HumanoidStateType.Physics)
    task.wait(DASH_DURATION)
    
    bv:Destroy()
    track:Stop()
    anim:Destroy()
    if dashAfterimageConnection then dashAfterimageConnection:Disconnect(); dashAfterimageConnection = nil end
    toggleCharacterVisibility(char, true)
    humanoid:ChangeState(Enum.HumanoidStateType.Running)
    
    task.wait(COOLDOWN_TIME)
    dashCooldown = false
end

local function startMoonwalkLoop()
    moonwalkConnection = RunService.RenderStepped:Connect(function()
        if not moonwalkActive or not isScriptEnabled then return end
        local char = LocalPlayer.Character
        local humanoid = char and char:FindFirstChild("Humanoid")
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        if not (humanoid and hrp) then return end
        
        humanoid.AutoRotate = false
        hrp.CFrame = CFrame.lookAt(hrp.Position, Vector3.new(Camera.CFrame.Position.X, hrp.Position.Y, Camera.CFrame.Position.Z))
        for _, track in pairs(humanoid.Animator:GetPlayingAnimationTracks()) do
            if track.Speed > 0 then track:AdjustSpeed(-1) end
        end
    end)
end

-- ====================================================================
--                         MANAJEMEN GUI & STATE
-- ====================================================================

-- Satu fungsi untuk membersihkan semua state aktif
local function resetAllStates()
    isScriptEnabled = false
    
    -- Hentikan semua koneksi/loop
    if dashAfterimageConnection then dashAfterimageConnection:Disconnect(); dashAfterimageConnection = nil end
    if dashCooldownConnection then dashCooldownConnection:Disconnect(); dashCooldownConnection = nil end
    if moonwalkConnection then moonwalkConnection:Disconnect(); moonwalkConnection = nil end
    
    -- Reset status
    moonwalkActive = false
    dashCooldown = false
    
    -- Reset karakter ke kondisi normal
    local char = LocalPlayer.Character
    if char then
        toggleCharacterVisibility(char, true)
        local humanoid = char:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.AutoRotate = true
            for _, track in pairs(humanoid.Animator:GetPlayingAnimationTracks()) do
                track:AdjustSpeed(1)
            end
        end
    end
    
    -- Hapus semua efek visual di workspace
    if effectsFolder and effectsFolder.Parent then effectsFolder:Destroy() end
    for _, item in pairs(CollectionService:GetTagged("ScriptEffect")) do item:Destroy() end
end

-- Fungsi utama untuk membangun dan mengelola GUI
local function initializeGUI()
    -- Hapus semua sisa GUI sebelumnya untuk kebersihan
    for _, oldGui in pairs(LocalPlayer.PlayerGui:GetChildren()) do
        if oldGui.Name == "MainScriptControllerGUI" then oldGui:Destroy() end
    end
    
    -- Buat satu ScreenGui permanen
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "MainScriptControllerGUI"
    screenGui.ResetOnSpawn = false
    
    -- Buat "halaman" (Frame) untuk setiap mode
    local menuPage = Instance.new("Frame", screenGui)
    menuPage.Name = "MenuPage"
    menuPage.BackgroundTransparency = 1
    menuPage.Size = UDim2.fromScale(1, 1)
    
    local dashPage = Instance.new("Frame", screenGui)
    dashPage.Name = "DashPage"
    dashPage.BackgroundTransparency = 1
    dashPage.Size = UDim2.fromScale(1, 1)
    dashPage.Visible = false
    
    local moonwalkPage = Instance.new("Frame", screenGui)
    moonwalkPage.Name = "MoonwalkPage"
    moonwalkPage.BackgroundTransparency = 1
    moonwalkPage.Size = UDim2.fromScale(1, 1)
    moonwalkPage.Visible = false
    
    -- Fungsi untuk berpindah halaman
    local function switchPage(pageName)
        resetAllStates() -- Selalu reset state sebelum pindah halaman
        
        -- Sembunyikan semua halaman
        menuPage.Visible = false
        dashPage.Visible = false
        moonwalkPage.Visible = false
        
        -- Tampilkan halaman yang diminta & siapkan state-nya
        if pageName == "Menu" then
            menuPage.Visible = true
        elseif pageName == "Dash" then
            isScriptEnabled = true
            dashPage.Visible = true
            -- Mulai loop untuk update UI cooldown
            local cooldownOverlay = dashPage:FindFirstChild("DashButton"):FindFirstChild("CooldownOverlay")
            dashCooldownConnection = RunService.Heartbeat:Connect(function()
                if not cooldownOverlay or not cooldownOverlay.Parent then dashCooldownConnection:Disconnect(); return end
                cooldownOverlay.Size = dashCooldown and UDim2.fromScale(1, 1) or UDim2.fromScale(1, 0)
            end)
        elseif pageName == "Moonwalk" then
            isScriptEnabled = true
            moonwalkPage.Visible = true
            startMoonwalkLoop() -- Mulai loop logika moonwalk
        end
    end
    
    -- ---------------------------------
    -- Isi Halaman Menu 
    -- ---------------------------------
    do
        local menuContainer = Instance.new("Frame", menuPage)
        menuContainer.Name = "MenuContainer"
        menuContainer.BackgroundTransparency = 1 
        menuContainer.Position = UDim2.new(0.5, 0, 0.5, 0)
        menuContainer.AnchorPoint = Vector2.new(0.5, 0.5)
        
        local listLayout = Instance.new("UIListLayout", menuContainer)
        listLayout.FillDirection = Enum.FillDirection.Vertical
        listLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
        listLayout.VerticalAlignment = Enum.VerticalAlignment.Center
        listLayout.Padding = UDim.new(0, MENU_ITEM_GAP)

        local function createMenuButton(parent, text, bgColor, action)
            local button = Instance.new("TextButton")
            button.Name = text:gsub("[^A-Za-z]", "") 
            -- Tombol Menu Utama TIDAK TRANSPARAN
            button.BackgroundTransparency = 0 
            button.BackgroundColor3 = bgColor
            button.Text = text
            button.TextColor3 = Color3.fromRGB(255, 255, 255)
            button.Font = Enum.Font.GothamBold
            button.TextSize = 16
            button.TextXAlignment = Enum.TextXAlignment.Center 
            button.TextScaled = false 
            button.Size = UDim2.new(0, 100, 0, MENU_BUTTON_HEIGHT) 
            Instance.new("UICorner", button).CornerRadius = UDim.new(0, 8)
            button.Activated:Connect(action)
            button.Parent = parent 
            return button
        end

        local dashBtn = createMenuButton(menuContainer, "‚ö° DASH (Lari Cepat)", DASH_COLOR, function() switchPage("Dash") end)
        local mwBtn = createMenuButton(menuContainer, "üåô JALAN MUNDUR", Color3.fromRGB(40, 40, 45), function() switchPage("Moonwalk") end)
        local disableBtn = createMenuButton(menuContainer, "‚ùå MATIKAN SEMUA", Color3.fromRGB(180, 30, 30), function() switchPage("None") end)
        
        local buttons = {dashBtn, mwBtn, disableBtn}
        local maxWidth = 0
        
        for _, button in pairs(buttons) do
            local textBounds = TextService:GetTextSize(
                button.Text, 
                button.TextSize, 
                button.Font, 
                Vector2.new(math.huge, MENU_BUTTON_HEIGHT) 
            )
            local requiredWidth = textBounds.X + PADDING_X
            maxWidth = math.max(maxWidth, requiredWidth)
        end
        
        local finalSize = UDim2.new(0, maxWidth, 0, MENU_BUTTON_HEIGHT)
        for _, button in pairs(buttons) do
            button.Size = finalSize
        end
        
        local containerHeight = (MENU_BUTTON_HEIGHT * #buttons) + (MENU_ITEM_GAP * (#buttons - 1))
        local containerWidth = maxWidth
        menuContainer.Size = UDim2.new(0, containerWidth, 0, containerHeight)

    end
    
    -- ---------------------------------
    -- Isi Halaman Dash
    -- ---------------------------------
    do
        local dashButton = Instance.new("TextButton", dashPage)
        dashButton.Name = "DashButton"
        dashButton.Size = BUTTON_SIZE
        dashButton.Position = BUTTON_POSITION
        -- >> PERUBAHAN: AnchorPoint diubah menjadi (0, 0)
        dashButton.AnchorPoint = Vector2.new(0, 0) 
        -- Transparansi 0.5
        dashButton.BackgroundTransparency = 0.5
        dashButton.BackgroundColor3 = DASH_COLOR 
        dashButton.Text = "‚ö°"
        dashButton.TextSize = 24
        dashButton.Font = Enum.Font.GothamBold
        dashButton.TextColor3 = Color3.new(1,1,1)
        Instance.new("UICorner", dashButton).CornerRadius = UDim.new(0.5, 0)
        
        local cooldownOverlay = Instance.new("Frame", dashButton)
        cooldownOverlay.Name = "CooldownOverlay"
        cooldownOverlay.BackgroundColor3 = Color3.new(0,0,0)
        cooldownOverlay.BackgroundTransparency = 0.4
        cooldownOverlay.Size = UDim2.fromScale(1, 0)
        cooldownOverlay.AnchorPoint = Vector2.new(0, 1)
        cooldownOverlay.Position = UDim2.fromScale(0, 1)
        Instance.new("UICorner", cooldownOverlay).CornerRadius = UDim.new(0.5, 0)
        
        -- Tombol Menu (Pengaturan) - TETAP DI TENGAH BAWAH
        local menuButton = Instance.new("TextButton", dashPage)
        menuButton.Size = MENU_BUTTON_SIZE
        menuButton.Position = MENU_BUTTON_POSITION
        menuButton.AnchorPoint = Vector2.new(0.5, 1)
        -- Transparansi 0.5
        menuButton.BackgroundTransparency = 0.5
        menuButton.BackgroundColor3 = Color3.fromRGB(50,50,50)
        menuButton.Text = "‚öôÔ∏è"
        menuButton.TextSize = 20
        menuButton.Font = Enum.Font.GothamBold
        menuButton.TextColor3 = Color3.new(1,1,1)
        Instance.new("UICorner", menuButton).CornerRadius = UDim.new(0.5, 0)
        
        dashButton.Activated:Connect(doDash)
        menuButton.Activated:Connect(function() switchPage("Menu") end)
    end
    
    -- ---------------------------------
    -- Isi Halaman Moonwalk
    -- ---------------------------------
    do
        local mwButton = Instance.new("TextButton", moonwalkPage)
        mwButton.Name = "MWButton"
        mwButton.Size = BUTTON_SIZE
        mwButton.Position = BUTTON_POSITION
        -- >> PERUBAHAN: AnchorPoint diubah menjadi (0, 0)
        mwButton.AnchorPoint = Vector2.new(0, 0)
        -- Transparansi 0.5
        mwButton.BackgroundTransparency = 0.5 
        mwButton.BackgroundColor3 = Color3.fromRGB(30,30,30)
        mwButton.Text = "üåô"
        mwButton.TextSize = 24
        mwButton.Font = Enum.Font.GothamBold
        mwButton.TextColor3 = Color3.new(1,1,1)
        Instance.new("UICorner", mwButton).CornerRadius = UDim.new(0.5, 0)
        
        local statusLabel = Instance.new("TextLabel", mwButton)
        statusLabel.Name = "StatusLabel"
        statusLabel.BackgroundTransparency = 1
        statusLabel.Position = UDim2.new(0, 0, 1, -15)
        statusLabel.Size = UDim2.new(1, 0, 0.5, 0)
        statusLabel.Text = "OFF"
        statusLabel.TextColor3 = Color3.fromRGB(255, 50, 50)
        statusLabel.TextSize = 12
        statusLabel.Font = Enum.Font.GothamBold
        
        -- Tombol Menu (Pengaturan) - TETAP DI TENGAH BAWAH
        local menuButton = Instance.new("TextButton", moonwalkPage)
        menuButton.Size = MENU_BUTTON_SIZE
        menuButton.Position = MENU_BUTTON_POSITION
        menuButton.AnchorPoint = Vector2.new(0.5, 1)
        -- Transparansi 0.5
        menuButton.BackgroundTransparency = 0.5
        menuButton.BackgroundColor3 = Color3.fromRGB(50,50,50)
        menuButton.Text = "‚öôÔ∏è"
        menuButton.TextSize = 20
        menuButton.Font = Enum.Font.GothamBold
        menuButton.TextColor3 = Color3.new(1,1,1)
        Instance.new("UICorner", menuButton).CornerRadius = UDim.new(0.5, 0)

        mwButton.Activated:Connect(function()
            moonwalkActive = not moonwalkActive
            if moonwalkActive then
                statusLabel.Text, statusLabel.TextColor3 = "ON", Color3.fromRGB(0, 255, 100)
            else
                statusLabel.Text, statusLabel.TextColor3 = "OFF", Color3.fromRGB(255, 50, 50)
                -- Reset state karakter saat dimatikan
                local char = LocalPlayer.Character
                if char and char:FindFirstChildOfClass("Humanoid") then
                    char.Humanoid.AutoRotate = true
                    for _, track in pairs(char.Humanoid.Animator:GetPlayingAnimationTracks()) do track:AdjustSpeed(1) end
                end
            end
        end)
        menuButton.Activated:Connect(function() switchPage("Menu") end)
    end
    
    -- Pasang GUI ke Player
    screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    print("‚úÖ GUI Terpadu Berhasil Dibuat!")
    
    -- Kembalikan ke menu utama jika karakter mati
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local humanoid = char:WaitForChild("Humanoid")
    humanoid.Died:Connect(function()
        task.wait(1) 
        switchPage("Menu")
    end)
    
    -- Tampilkan Menu Utama Transparan saat inisialisasi
    switchPage("Menu")
end

-- ====================================================================
--                         INisialisasi
-- ====================================================================
initializeGUI()

