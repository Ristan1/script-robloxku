--  Online Admin/Owner List GUI (Optimized & Combined Detection)
-- Dibuat oleh: Gemini
-- Fitur: Mendeteksi dari UserID, Grup, DAN tag tulisan di atas kepala.
-- PERBAIKAN: Frame GUI sekarang muncul tepat di tengah layar saat diaktifkan.

local Players = game:GetService("Players")
local player = Players.LocalPlayer

-- Tabel untuk menyimpan semua koneksi event agar bisa di-cleanup
local connections = {}
local playerCharacterConnections = {}

-- ==================================
-- KONFIGURASI (Silakan ubah bagian ini)
-- ==================================
local adminUserIds = {12345678, 87654321} -- Ganti dengan UserID admin kustom Anda
local groupId = nil                         -- Ganti dengan GroupID jika ingin cek admin dari grup
local minGroupRank = 200                    -- Rank minimal untuk dianggap admin grup

-- Warna untuk tag di map & list
local ownerColor = Color3.fromRGB(255, 200, 0)      -- Emas
local adminColor = Color3.fromRGB(50, 150, 255)       -- Biru
local groupAdminColor = Color3.fromRGB(0, 200, 100) -- Hijau
local detectedAdminColor = Color3.fromRGB(255, 90, 90) -- Merah muda (untuk admin yg terdeteksi dari tag)


-- ==================================
-- BAGIAN INTI (Jangan diubah jika tidak paham)
-- ==================================

-- Helper function untuk memindai tag di atas kepala karakter
local function scanCharacterForTag(character)
	if not character or not character:FindFirstChild("Head") then return nil end
	local head = character.Head
	for _, descendant in ipairs(head:GetDescendants()) do
		if descendant:IsA("TextLabel") then
			local text = string.lower(descendant.Text)
			if text:match("owner") then
				return "Detected Owner"
			elseif text:match("admin") then
				return "Detected Admin"
			elseif text:match("moderator") or text:match("mod") then
				return "Detected Mod"
			end
		end
	end
	return nil
end

-- Fungsi utama untuk mendapatkan status pemain
local function getPlayerStatus(targetPlayer)
	if not targetPlayer then return nil end
	if game.CreatorType == Enum.CreatorType.User then
		if targetPlayer.UserId == game.CreatorId then return "Owner", ownerColor end
	elseif game.CreatorType == Enum.CreatorType.Group then
		if targetPlayer:GetRankInGroup(game.CreatorId) >= 255 then return "Owner", ownerColor end
	end
	for _, id in ipairs(adminUserIds) do
		if id == targetPlayer.UserId then return "Admin", adminColor end
	end
	if groupId and groupId > 0 then
		local success, rank = pcall(function() return targetPlayer:GetRankInGroup(groupId) end)
		if success and rank and rank >= minGroupRank then return "Group Admin", groupAdminColor end
	end
	local character = targetPlayer.Character
	if character then
		local detectedStatus = scanCharacterForTag(character)
		if detectedStatus then
			return detectedStatus, detectedAdminColor
		end
	end
	return nil
end

-- LOGIKA PENTING: Periksa dan Hapus GUI lama sebelum membuat yang baru
if player.PlayerGui:FindFirstChild("AdminListGUI") then
	player.PlayerGui.AdminListGUI:Destroy()
	print("[Admin/Owner List GUI] Instansi GUI lama ditemukan dan dihentikan. Membuat instansi baru.")
end


-- ==================================
-- PEMBUATAN GUI (Tampilan)
-- ==================================
local screenGui = Instance.new("ScreenGui", player.PlayerGui)
screenGui.Name = "AdminListGUI"
screenGui.ResetOnSpawn = false

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 250, 0, 300)
-- PERUBAHAN DI SINI: Mengatur posisi ke (0.5, 0.5) untuk centering sempurna
frame.Position = UDim2.new(0.5, 0, 0.5, 0) 
frame.BackgroundTransparency = 0.2
frame.BackgroundColor3 = Color3.fromRGB(30, 32, 36)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
frame.AnchorPoint = Vector2.new(0.5, 0.5) -- AnchorPoint 0.5, 0.5 berarti pusat frame adalah titik referensi
frame.Parent = screenGui
local corner = Instance.new("UICorner", frame)
corner.CornerRadius = UDim.new(0, 8)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1, -90, 0, 35)
title.Position = UDim2.new(0, 10, 0, 0)
title.BackgroundTransparency = 1
title.Text = "Online Admin/Owner"
title.Font = Enum.Font.GothamBold
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextSize = 18
title.TextXAlignment = Enum.TextXAlignment.Left

local scrollingFrame = Instance.new("ScrollingFrame", frame)
scrollingFrame.Size = UDim2.new(1, -20, 1, -45)
scrollingFrame.Position = UDim2.new(0, 10, 0, 40)
scrollingFrame.BackgroundTransparency = 0.5
scrollingFrame.BackgroundColor3 = Color3.fromRGB(22, 23, 26)
scrollingFrame.BorderSizePixel = 0
scrollingFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
scrollingFrame.ScrollBarThickness = 6
local scrollCorner = Instance.new("UICorner", scrollingFrame)
scrollCorner.CornerRadius = UDim.new(0, 4)

local listLayout = Instance.new("UIListLayout", scrollingFrame)
listLayout.Padding = UDim.new(0, 5)
listLayout.FillDirection = Enum.FillDirection.Vertical
listLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center

-- Tombol Close (X)
local closeBtn = Instance.new("TextButton", frame)
closeBtn.Name = "CloseButton"
closeBtn.Size = UDim2.new(0, 25, 0, 25)
closeBtn.Position = UDim2.new(1, -30, 0, 5)
closeBtn.Text = "X"
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
closeBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
local closeCorner = Instance.new("UICorner", closeBtn)
closeCorner.CornerRadius = UDim.new(0, 4)

-- Tombol Minimize (-)
local minBtn = Instance.new("TextButton", frame)
minBtn.Name = "MinimizeButton"
minBtn.Size = UDim2.new(0, 25, 0, 25)
minBtn.Position = UDim2.new(1, -60, 0, 5)
minBtn.Text = "â€”"
minBtn.Font = Enum.Font.GothamBold
minBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
minBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
local minCorner = Instance.new("UICorner", minBtn)
minCorner.CornerRadius = UDim.new(0, 4)

-- Tombol kecil "STAFF" (Muncul saat Minimize)
local miniGui = Instance.new("TextButton", screenGui)
miniGui.Name = "ShowAdminListButton"
miniGui.Size = UDim2.new(0, 80, 0, 30)
miniGui.Position = UDim2.new(1, -90, 0, 10)
miniGui.Text = "STAFF"
miniGui.Font = Enum.Font.GothamBold
miniGui.TextSize = 16
miniGui.TextColor3 = Color3.fromRGB(255, 255, 255)
miniGui.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
miniGui.Visible = false
local miniGuiCorner = Instance.new("UICorner", miniGui)
miniGuiCorner.CornerRadius = UDim.new(0, 8)

-- ==================================
-- FUNGSI UTAMA (LOGIKA & EVENT)
-- ==================================

function updateAdminListGUI()
	for _, child in ipairs(scrollingFrame:GetChildren()) do
		if child:IsA("TextLabel") then child:Destroy() end
	end
	local adminCount = 0
	for _, p in ipairs(Players:GetPlayers()) do
		local status, statusColor = getPlayerStatus(p)
		if status then
			adminCount = adminCount + 1
			local label = Instance.new("TextLabel")
			label.Size = UDim2.new(1, 0, 0, 25)
			label.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
			label.TextColor3 = statusColor
			label.Font = Enum.Font.Gotham
			label.TextSize = 14
			label.Text = string.format(" %s (@%s) [%s]", p.DisplayName, p.Name, status)
			label.TextXAlignment = Enum.TextXAlignment.Left
			label.Parent = scrollingFrame
			local labelCorner = Instance.new("UICorner", label)
			labelCorner.CornerRadius = UDim.new(0, 4)
		end
	end
	scrollingFrame.CanvasSize = UDim2.new(0, 0, 0, adminCount * 30 + 5)
end

function setupOverheadTag(targetPlayer)
	-- PENTING: Disconnect koneksi CharacterAdded lama jika ada
	if playerCharacterConnections[targetPlayer.UserId] and playerCharacterConnections[targetPlayer.UserId].Connected then
		playerCharacterConnections[targetPlayer.UserId]:Disconnect()
	end
	
	local function createOrUpdateTag(character)
		if not character or not character:FindFirstChild("Head") then return end
		local head = character.Head
		local existingTag = head:FindFirstChild("AdminStatusTag")
		if existingTag then existingTag:Destroy() end

		local status, statusColor = getPlayerStatus(targetPlayer)
		if not status or status:match("Detected") then return end

		local billboardGui = Instance.new("BillboardGui", head)
		billboardGui.Name = "AdminStatusTag"
		billboardGui.Adornee = head
		billboardGui.Size = UDim2.new(0, 200, 0, 60)
		billboardGui.StudsOffset = Vector3.new(0, 2.5, 0)
		billboardGui.AlwaysOnTop = true

		local nameLabel = Instance.new("TextLabel", billboardGui)
		nameLabel.Size = UDim2.new(1, 0, 0.5, 0)
		nameLabel.BackgroundTransparency = 1
		nameLabel.Text = string.format("%s (@%s)", targetPlayer.DisplayName, targetPlayer.Name)
		nameLabel.Font = Enum.Font.GothamBold
		nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
		nameLabel.TextScaled = true

		local statusLabel = Instance.new("TextLabel", billboardGui)
		statusLabel.Size = UDim2.new(0.8, 0, 0.4, 0)
		statusLabel.Position = UDim2.new(0.1, 0, 0.5, 0)
		statusLabel.BackgroundColor3 = statusColor
		statusLabel.Text = status
		statusLabel.Font = Enum.Font.GothamBold
		statusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
		statusLabel.TextScaled = true
		local statusCorner = Instance.new("UICorner", statusLabel)
		statusCorner.CornerRadius = UDim.new(0, 8)
	end
	
	-- Simpan koneksi CharacterAdded yang baru
	playerCharacterConnections[targetPlayer.UserId] = targetPlayer.CharacterAdded:Connect(createOrUpdateTag)
	
	if targetPlayer.Character then createOrUpdateTag(targetPlayer.Character) end
end

-- ==================================
-- FUNGSI CLEANUP (Dipanggil saat Close)
-- ==================================
local function cleanup()
	-- 1. Putuskan koneksi utama (PlayerAdded, PlayerRemoving)
	for _, conn in pairs(connections) do
		if conn and conn.Connected then
			conn:Disconnect()
		end
	end
	
	-- 2. Putuskan semua koneksi CharacterAdded per pemain
	for _, conn in pairs(playerCharacterConnections) do
		if conn and conn.Connected then
			conn:Disconnect()
		end
	end
	
	-- 3. HAPUS SEMUA TAG YANG SUDAH ADA DI ATAS KEPALA PEMAIN (FIX)
	print("[Admin/Owner List GUI] Menghapus tag overhead yang ada...")
	for _, p in ipairs(Players:GetPlayers()) do
		if p.Character then
			local head = p.Character:FindFirstChild("Head")
			if head then
				local adminTag = head:FindFirstChild("AdminStatusTag")
				if adminTag then
					adminTag:Destroy()
				end
			end
		end
	end
	
	-- 4. Hancurkan GUI
	if screenGui and screenGui.Parent then
		screenGui:Destroy()
	end
	print("[Admin/Owner List GUI] Skrip dan semua koneksi event berhasil dihentikan sepenuhnya.")
end


-- ==================================
-- KONEKSI EVENT & EKSEKUSI AWAL
-- ==================================

-- Setup Awal
updateAdminListGUI()

for _, p in ipairs(Players:GetPlayers()) do
	setupOverheadTag(p)
	
	-- Logika update list saat karakter muncul (selain dari setupOverheadTag)
	connections[p.UserId .. "_charUpdate"] = p.CharacterAdded:Connect(function()
		task.wait(2)
		updateAdminListGUI()
	end)
end

-- Simpan koneksi PlayerAdded dan PlayerRemoving
connections.PlayerAdded = Players.PlayerAdded:Connect(function(newPlayer)
	setupOverheadTag(newPlayer)
	connections[newPlayer.UserId .. "_charUpdate"] = newPlayer.CharacterAdded:Connect(function()
		task.wait(2)
		updateAdminListGUI()
	end)
	task.wait(0.1)
	updateAdminListGUI()
end)

connections.PlayerRemoving = Players.PlayerRemoving:Connect(function(removedPlayer)
	-- Hapus koneksi CharacterAdded pemain yang keluar
	if playerCharacterConnections[removedPlayer.UserId] and playerCharacterConnections[removedPlayer.UserId].Connected then
		playerCharacterConnections[removedPlayer.UserId]:Disconnect()
		playerCharacterConnections[removedPlayer.UserId] = nil
	end
	if connections[removedPlayer.UserId .. "_charUpdate"] then
		connections[removedPlayer.UserId .. "_charUpdate"]:Disconnect()
		connections[removedPlayer.UserId .. "_charUpdate"] = nil
	end
	task.wait(0.1)
	updateAdminListGUI()
end)


-- KONEKSI TOMBOL
minBtn.MouseButton1Click:Connect(function()
	frame.Visible = false
	miniGui.Visible = true
end)

miniGui.MouseButton1Click:Connect(function()
	frame.Visible = true
	miniGui.Visible = false
end)

-- Tombol Close (X) sekarang memanggil fungsi cleanup()
closeBtn.MouseButton1Click:Connect(cleanup)

print("[Admin/Owner List GUI] Loaded Successfully. Skrip siap untuk cleanup penuh saat ditutup.")
