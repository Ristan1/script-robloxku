-- Roblox Path Finder & Fake Part Detector
-- Menunjukkan jalur yang benar dan mendeteksi part palsu
-- [VERSI STABIL oleh Gemini]
-- [MODIFIKASI v10: Perbaikan "StreamingEnabled" & Daftar CP Persistent]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local PathfindingService = game:GetService("PathfindingService")

local player = Players.LocalPlayer
if not player then
    warn("Path Finder: Tidak dapat menemukan LocalPlayer.")
    return
end

-- Variabel ini akan diisi setelah karakter dimuat
local character = player.Character
local humanoidRootPart = character and character:FindFirstChild("HumanoidRootPart")

-- Konfigurasi
local CONFIG = {
    pathColor = Color3.fromRGB(0, 255, 0), -- Hijau untuk jalur benar
    fakePartColor = Color3.fromRGB(255, 0, 0), -- Merah untuk part palsu
    realPartColor = Color3.fromRGB(0, 255, 255), -- Cyan untuk part asli
    lineThickness = 0.3,
    maxDistance = 1000,
    espDistance = 10,
    -- Jarak deteksi
    fakePartDistance = 30,
    checkpointActivationDistance = 10, -- Jarak (stud) untuk auto-next CP
    checkpointSyncDistance = 50, -- Jarak untuk sinkronisasi (spawn)
    updateInterval = 0.5,
    checkpointScanInterval = 10, -- [[v10: Dibuat lebih cepat untuk menemukan CP baru]]
    showESP = false, -- [Default OFF]
    showPath = false, -- [Default OFF]
    
    -- [[ FITUR v6: Konfigurasi Labyrinth "Sonar" ]]
    showRaycast = false, -- [Default OFF]
    raycastDistance = 150,
    raycastThickness = 0.2,
    raycastAngles = { 0, 15, -15, 30, -30 }
}

-- Variabel untuk tracking checkpoint
local currentCheckpointIndex = 0
local allCheckpoints = {} -- [[v10: Daftar ini sekarang persistent!]]
local targetCheckpoint = nil

-- Tabel untuk menyimpan ESP
local espObjects = {}
local pathLines = {}
local raycastVisuals = {}

-- GUI Elements (dideklarasikan di sini agar bisa diakses)
local CPInfo

-- Koneksi (untuk dimatikan nanti)
local heartbeatConnection = nil
local charAddedConnection = nil

-- Fungsi untuk membersihkan ESP lama
local function clearESP()
    for _, obj in pairs(espObjects) do
        if obj and obj.Parent then pcall(function() obj:Destroy() end) end
    end
    espObjects = {}
end

-- Fungsi untuk membersihkan garis jalur
local function clearPath()
    for _, line in pairs(pathLines) do
        if line and line.Parent then pcall(function() line:Destroy() end) end
    end
    pathLines = {}
end

-- Fungsi untuk membersihkan visual raycast
local function clearRaycastVisuals()
    for _, obj in pairs(raycastVisuals) do
        if obj and obj.Parent then pcall(function() obj:Destroy() end) end
    end
    raycastVisuals = {}
end

-- Fungsi untuk mengecek apakah part bisa diinjak
local function isPartFake(part)
-- ... (Fungsi tidak berubah) ...
    if not part:IsA("BasePart") then return false end
    if part.CanCollide == false then
        return true
    end
    return false
end

-- Fungsi untuk mengecek apakah part adalah checkpoint
local function isCheckpoint(part)
-- ... (Fungsi tidak berubah) ...
    local name = part.Name:lower()
    return name:find("checkpoint") or name:find("cp") or name:find("finish") or 
           name:find("end") or name:find("goal") or name:find("stage")
end

-- Fungsi untuk mendapatkan nomor checkpoint dari nama
local function getCheckpointNumber(part)
-- ... (Fungsi tidak berubah) ...
    local name = part.Name
    local number = tonumber(name:match("%d+"))
    return number or 0
end

-- [[ DIPERBARUI v10: discoverCheckpoints (Persistent List) ]]
-- Fungsi ini TIDAK menghapus 'allCheckpoints', tapi MENAMBAHKAN CP baru ke dalamnya
local function discoverCheckpoints()
    local listWasModified = false
    
    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("BasePart") and isCheckpoint(obj) then
            local cpNumber = getCheckpointNumber(obj)
            
            -- Cek apakah kita sudah menyimpan part ini
            local found = false
            for _, existingCp in ipairs(allCheckpoints) do
                if existingCp.part == obj then
                    found = true
                    -- Update posisi jika berubah
                    if existingCp.position ~= obj.Position then
                         existingCp.position = obj.Position
                    end
                    break
                end
            end
            
            -- Jika belum ada di daftar, tambahkan!
            if not found then
                print("Path Finder: Menemukan CP baru: " .. cpNumber)
                table.insert(allCheckpoints, {
                    part = obj,
                    number = cpNumber,
                    position = obj.Position -- Simpan posisi!
                })
                listWasModified = true
            end
        end
    end
    
    -- Jika kita menambahkan CP baru, urutkan ulang daftarnya
    if listWasModified then
        print("Path Finder: Mengurutkan ulang daftar " .. #allCheckpoints .. " CP...")
        table.sort(allCheckpoints, function(a, b)
            return a.number < b.number
        end)
    end
    
    return allCheckpoints
end

-- [[ DIPERBARUI v10: findCurrentCheckpoint (Anti-Reset) ]]
-- Fungsi ini HANYA akan memajukan index, tidak akan memundurkannya
local function findCurrentCheckpoint()
    if not humanoidRootPart or not humanoidRootPart.Parent or #allCheckpoints == 0 then 
        return currentCheckpointIndex
    end
    
    local playerPos = humanoidRootPart.Position
    local nearestDistance = math.huge
    local nearestIndex = -1 
    
    -- Cari CP terdekat dari player
    for i, cp in ipairs(allCheckpoints) do
        -- Hanya cek part yang valid
        if cp and cp.part and cp.part.Parent then
            local distance = (cp.position - playerPos).Magnitude
            if distance < nearestDistance then
                nearestDistance = distance
                nearestIndex = i
            end
        end
    end
    
    -- Jika kita menemukan CP terdekat DAN kita cukup dekat...
    if nearestIndex > 0 and nearestDistance < CONFIG.checkpointSyncDistance then 
        -- [[ PERUBAHAN PENTING v10 ]]
        -- HANYA update index jika index baru > index sekarang
        -- Ini mencegah progress kita di-reset ke CP 1 jika kita respawn
        if nearestIndex > currentCheckpointIndex then
            print("Sinkronisasi CP: Player dekat CP " .. allCheckpoints[nearestIndex].number .. " (Index: " .. nearestIndex .. ")")
            currentCheckpointIndex = nearestIndex
        end
    end
    
    return currentCheckpointIndex
end

-- [[ Logika getNextCheckpoint (v8) ]]
local function getNextCheckpoint()
    if #allCheckpoints == 0 then return nil end
    
    if currentCheckpointIndex <= 0 then
        if allCheckpoints[1] then
            return allCheckpoints[1]
        else
            return nil
        end
    end
    
    if currentCheckpointIndex >= #allCheckpoints then
        return allCheckpoints[#allCheckpoints]
    end
    
    local nextIndex = currentCheckpointIndex + 1
    return allCheckpoints[nextIndex]
end

-- [[ Logika getPreviousCheckpoint (v9) ]]
local function getPreviousCheckpoint()
    if #allCheckpoints == 0 then return nil end

    if currentCheckpointIndex <= 1 then
        if allCheckpoints[1] then
            return allCheckpoints[1]
        else
            return nil
        end
    end
    
    if currentCheckpointIndex > #allCheckpoints then
        return allCheckpoints[#allCheckpoints]
    end
    
    local prevIndex = currentCheckpointIndex
    if prevIndex > 1 then
        prevIndex = currentCheckpointIndex - 1
    end
    
    return allCheckpoints[prevIndex]
end


-- Fungsi untuk membuat ESP Box pada part
local function createESP(part, color, text)
-- ... (Fungsi tidak berubah) ...
    if not part or not part.Parent or not part:IsA("BasePart") then return end 
    
    local distance = (part.Position - humanoidRootPart.Position).Magnitude
    if distance > CONFIG.fakePartDistance then
        return
    end
    
    local box = Instance.new("BoxHandleAdornment")
    box.Size = part.Size + Vector3.new(0.1, 0.1, 0.1)
    box.Color3 = color
    box.Transparency = 0.7
    box.AlwaysOnTop = true
    box.ZIndex = 1
    box.Adornee = part
    box.Parent = part
    
    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Size = UDim2.new(0, 100, 0, 40)
    billboardGui.StudsOffset = Vector3.new(0, 2, 0)
    billboardGui.AlwaysOnTop = true
    billboardGui.Adornee = part
    billboardGui.Parent = part
    
    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = text
    textLabel.TextColor3 = color
    textLabel.TextStrokeTransparency = 0
    textLabel.TextScaled = true
    textLabel.Font = Enum.Font.GothamBold
    textLabel.Parent = billboardGui
    
    table.insert(espObjects, box)
    table.insert(espObjects, billboardGui)
end

-- Fungsi untuk membuat garis penunjuk jalur
local function createPathLine(from, to, color)
-- ... (Fungsi tidak berubah) ...
    local beam = Instance.new("Part")
    beam.Anchored = true
    beam.CanCollide = false
    beam.Size = Vector3.new(CONFIG.lineThickness, CONFIG.lineThickness, (to - from).Magnitude)
    beam.CFrame = CFrame.new(from, to) * CFrame.new(0, 0, -beam.Size.Z / 2)
    beam.Color = color
    beam.Material = Enum.Material.Neon
    beam.Transparency = 0.3
    beam.Parent = Workspace
    
    table.insert(pathLines, beam)
    return beam
end

-- Fungsi untuk membuat visual raycast
local function createRaycastLine(from, to, color)
-- ... (Fungsi tidak berubah) ...
    local line = Instance.new("Part")
    line.Anchored = true
    line.CanCollide = false
    line.Size = Vector3.new(CONFIG.raycastThickness, CONFIG.raycastThickness, (to - from).Magnitude)
    line.CFrame = CFrame.new(from, to) * CFrame.new(0, 0, -line.Size.Z / 2)
    line.Color = color
    line.Material = Enum.Material.Neon
    line.Transparency = 0.5
    line.Parent = Workspace
    table.insert(raycastVisuals, line)
end

-- [[ Logika updateCPInfo (v8) ]]
local function updateCPInfo()
    if not CPInfo or not CPInfo.Parent then return end
    
    if not humanoidRootPart or not humanoidRootPart.Parent then
        CPInfo.Text = "Waiting for character..."
        return
    end
    
    local totalCPs = #allCheckpoints
    local displayCPNumber = 0
    
    if currentCheckpointIndex > 0 and currentCheckpointIndex <= totalCPs then
        if allCheckpoints[currentCheckpointIndex] then
             displayCPNumber = allCheckpoints[currentCheckpointIndex].number
        else
            -- findCurrentCheckpoint() -- Biarkan loop utama yg sinkronisasi
        end
    end
    
    CPInfo.Text = "Current CP: " .. displayCPNumber .. " (Total " .. totalCPs .. ")"
    
    -- [[ DIPERBARUI v10: Cek target.position, bukan target.part ]]
    if targetCheckpoint and targetCheckpoint.position then
        local distance = (targetCheckpoint.position - humanoidRootPart.Position).Magnitude
        CPInfo.Text = CPInfo.Text .. "\nTarget: " .. targetCheckpoint.number .. " (" .. math.floor(distance) .. "m)"
    else
        targetCheckpoint = getNextCheckpoint()
        if targetCheckpoint and targetCheckpoint.position then
             local distance = (targetCheckpoint.position - humanoidRootPart.Position).Magnitude
             CPInfo.Text = CPInfo.Text .. "\nTarget: " .. targetCheckpoint.number .. " (" .. math.floor(distance) .. "m)"
        else
             CPInfo.Text = CPInfo.Text .. "\nTarget: (Scanning...)"
        end
    end
end

-- [[ DIPERBARUI v10: scanEnvironment (Pathfinding ke Koordinat) ]]
local function scanEnvironment()
    clearESP()
    clearRaycastVisuals()
    
    if not humanoidRootPart or not humanoidRootPart.Parent then return end
    
    local currentPos = humanoidRootPart.Position
    
    -- [[ Logika Auto-Next CP (v9) ]]
    if targetCheckpoint and targetCheckpoint.part and targetCheckpoint.part.Parent then
        local distanceToTarget = (currentPos - targetCheckpoint.position).Magnitude

        if distanceToTarget < CONFIG.checkpointActivationDistance then
            local targetIndex = -1
            for i, cp in ipairs(allCheckpoints) do
                if cp.part == targetCheckpoint.part then
                    targetIndex = i
                    break
                end
            end

            if targetIndex > 0 and targetIndex >= currentCheckpointIndex then
                currentCheckpointIndex = targetIndex 
                local nextTarget = getNextCheckpoint()
                
                if nextTarget and nextTarget.position ~= targetCheckpoint.position then
                    targetCheckpoint = nextTarget
                    print("Auto-next! Target baru: " .. targetCheckpoint.number)
                end
            end
        end
    end

    -- Deteksi part palsu
    if CONFIG.showESP then
        -- ... (Logika ESP tidak berubah) ...
        local region = Region3.new(
            currentPos - Vector3.new(CONFIG.fakePartDistance, CONFIG.fakePartDistance, CONFIG.fakePartDistance),
            currentPos + Vector3.new(CONFIG.fakePartDistance, CONFIG.fakePartDistance, CONFIG.fakePartDistance)
        )
        region = region:ExpandToGrid(4)
        local partsInRegion = Workspace:FindPartsInRegion3(region, character, 1000)
        
        for _, part in pairs(partsInRegion) do
            local partParentModel = part:FindFirstAncestorWhichIsA("Model")
            local isPlayerPart = false
            if partParentModel then
                if Players:GetPlayerFromCharacter(partParentModel) then
                    isPlayerPart = true
                end
            end

            if part:IsA("BasePart") and not isPlayerPart then
                local playerLookVector = humanoidRootPart.CFrame.LookVector
                local vectorToPart = (part.Position - currentPos)
                local dotProduct = 0
                
                if vectorToPart.Magnitude > 0.1 then
                    dotProduct = playerLookVector:Dot(vectorToPart.Unit)
                end

                if dotProduct > 0.5 then
                    if isPartFake(part) then
                        createESP(part, CONFIG.fakePartColor, "FAKE!")
                    elseif part.CanCollide and not isCheckpoint(part) then
                        createESP(part, CONFIG.realPartColor, "SAFE")
                    end
                end
            end
        end
    end
    
    -- Tampilkan jalur
    clearPath()
    -- [[ PERUBAHAN PENTING v10: Cek 'targetCheckpoint.position' ]]
    if CONFIG.showPath and targetCheckpoint and targetCheckpoint.position then
        
        -- Kita pathfind ke KOORDINAT, bukan ke PART
        local targetPos = targetCheckpoint.position
        local distance = (targetPos - currentPos).Magnitude
        
        -- Buat ESP Box HANYA JIKA part-nya ada
        if targetCheckpoint.part and targetCheckpoint.part.Parent then
            local cpText = "CP " .. targetCheckpoint.number .. "\n" .. math.floor(distance) .. " studs"
            createESP(targetCheckpoint.part, Color3.fromRGB(0, 255, 0), cpText)
        end
        
        -- Pathfinding akan tetap jalan meskipun part-nya tidak ada
        local path = PathfindingService:CreatePath({
            AgentRadius = 3,
            AgentHeight = 6,
            AgentCanJump = true,
        })
        
        local success, errorMessage = pcall(function()
            path:ComputeAsync(currentPos, targetPos)
        end)
        
        if success and path.Status == Enum.PathStatus.Success then
            local waypoints = path:GetWaypoints()
            if #waypoints > 0 then
                createPathLine(currentPos, waypoints[1].Position, CONFIG.pathColor)
                for i = 1, #waypoints - 1 do
                    createPathLine(waypoints[i].Position, waypoints[i+1].Position, CONFIG.pathColor)
                end
                createPathLine(waypoints[#waypoints].Position, targetPos, CONFIG.pathColor)
            else
                createPathLine(currentPos, targetPos, CONFIG.pathColor)
            end
        else
            -- Jika pathfinding gagal (mungkin terlalu jauh), gambar garis lurus
            createPathLine(currentPos, targetPos, CONFIG.pathColor)
        end
    end
    
    -- [[ FITUR v6: Tampilkan Labyrinth "Sonar" Raycast ]]
    if CONFIG.showRaycast and humanoidRootPart and humanoidRootPart.Parent then
        local startPos = humanoidRootPart.Position
        local baseCFrame = humanoidRootPart.CFrame
        
        local raycastParams = RaycastParams.new()
        raycastParams.FilterDescendantsInstances = {character}
        raycastParams.FilterType = Enum.RaycastFilterType.Exclude
        
        local raycastDistance = CONFIG.raycastDistance
        
        for _, angle in ipairs(CONFIG.raycastAngles) do
            local direction = (baseCFrame * CFrame.Angles(0, math.rad(angle), 0)).LookVector
            local result = Workspace:Raycast(startPos, direction * raycastDistance, raycastParams)
            
            if result then
                createPathLine(startPos, result.Position, CONFIG.fakePartColor)
            else
                local endPos = startPos + direction * raycastDistance
                createPathLine(startPos, endPos, CONFIG.pathColor)
            end
        end
    end
end

-- === PEMBUATAN GUI (DIBUNGKUS PCALL) ===
local guiSuccess, guiError = pcall(function()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = player:WaitForChild("PlayerGui")

    local Frame = Instance.new("Frame")
    Frame.Size = UDim2.new(0, 220, 0, 260) 
    Frame.Position = UDim2.new(0, 10, 0.5, -130) 
    Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    Frame.BorderSizePixel = 0
    Frame.Parent = ScreenGui

    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 8)
    UICorner.Parent = Frame

    local Title = Instance.new("TextLabel")
    Title.Size = UDim2.new(1, 0, 0, 35)
    Title.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    Title.BorderSizePixel = 0
    Title.Text = "Path Finder Pro v10" -- v10
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.Font = Enum.Font.GothamBold
    Title.TextSize = 16
    Title.Parent = Frame

    local TitleCorner = Instance.new("UICorner")
    TitleCorner.CornerRadius = UDim.new(0, 8)
    TitleCorner.Parent = Title

    local CloseButton = Instance.new("TextButton")
    CloseButton.Size = UDim2.new(0, 20, 0, 20)
    CloseButton.Position = UDim2.new(1, -28, 0.5, -10)
    CloseButton.AnchorPoint = Vector2.new(0, 0.5)
    CloseButton.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
    CloseButton.Text = "X"
    CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    CloseButton.Font = Enum.Font.GothamBold
    CloseButton.TextSize = 12
    CloseButton.Parent = Title
    
    local CloseCorner = Instance.new("UICorner")
    CloseCorner.CornerRadius = UDim.new(0, 4)
    CloseCorner.Parent = CloseButton
    
    local MinimizeButton = Instance.new("TextButton")
    MinimizeButton.Size = UDim2.new(0, 20, 0, 20)
    MinimizeButton.Position = UDim2.new(1, -53, 0.5, -10)
    MinimizeButton.AnchorPoint = Vector2.new(0, 0.5)
    MinimizeButton.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
    MinimizeButton.Text = "—"
    MinimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    MinimizeButton.Font = Enum.Font.GothamBold
    MinimizeButton.TextSize = 12
    MinimizeButton.Parent = Title
    
    local MinimizeCorner = Instance.new("UICorner")
    MinimizeCorner.CornerRadius = UDim.new(0, 4)
    MinimizeCorner.Parent = MinimizeButton

    CPInfo = Instance.new("TextLabel")
    CPInfo.Size = UDim2.new(0.9, 0, 0, 40) 
    CPInfo.Position = UDim2.new(0.05, 0, 0, 45)
    CPInfo.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    CPInfo.BorderSizePixel = 0
    CPInfo.Text = "Loading..."
    CPInfo.TextColor3 = Color3.fromRGB(255, 255, 255)
    CPInfo.Font = Enum.Font.Gotham
    CPInfo.TextSize = 14
    CPInfo.TextYAlignment = Enum.TextYAlignment.Top
    CPInfo.TextWrapped = true
    CPInfo.Parent = Frame

    local CPCorner = Instance.new("UICorner")
    CPCorner.CornerRadius = UDim.new(0, 5)
    CPCorner.Parent = CPInfo

    local PrevCP = Instance.new("TextButton")
    PrevCP.Size = UDim2.new(0.42, 0, 0, 30)
    PrevCP.Position = UDim2.new(0.05, 0, 0, 95) 
    PrevCP.Text = "◄ Prev CP"
    PrevCP.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
    PrevCP.TextColor3 = Color3.fromRGB(255, 255, 255)
    PrevCP.Font = Enum.Font.GothamBold
    PrevCP.TextSize = 13
    PrevCP.Parent = Frame

    local PrevCorner = Instance.new("UICorner")
    PrevCorner.CornerRadius = UDim.new(0, 5)
    PrevCorner.Parent = PrevCP

    local NextCP = Instance.new("TextButton")
    NextCP.Size = UDim2.new(0.42, 0, 0, 30)
    NextCP.Position = UDim2.new(0.53, 0, 0, 95) 
    NextCP.Text = "Next CP ►"
    NextCP.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
    NextCP.TextColor3 = Color3.fromRGB(255, 255, 255)
    NextCP.Font = Enum.Font.GothamBold
    NextCP.TextSize = 13
    NextCP.Parent = Frame

    local NextCorner = Instance.new("UICorner")
    NextCorner.CornerRadius = UDim.new(0, 5)
    NextCorner.Parent = NextCP

    local ToggleESP = Instance.new("TextButton")
    ToggleESP.Size = UDim2.new(0.9, 0, 0, 30)
    ToggleESP.Position = UDim2.new(0.05, 0, 0, 135) 
    ToggleESP.BackgroundColor3 = CONFIG.showESP and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(170, 0, 0)
    ToggleESP.Text = "Deteksi Part palsu: " .. (CONFIG.showESP and "ON" or "OFF")
    ToggleESP.TextColor3 = Color3.fromRGB(255, 255, 255)
    ToggleESP.Font = Enum.Font.Gotham
    ToggleESP.TextSize = 14
    ToggleESP.Parent = Frame

    local ESPCorner = Instance.new("UICorner")
    ESPCorner.CornerRadius = UDim.new(0, 5)
    ESPCorner.Parent = ToggleESP

    local TogglePath = Instance.new("TextButton")
    TogglePath.Size = UDim2.new(0.9, 0, 0, 30)
    TogglePath.Position = UDim2.new(0.05, 0, 0, 175) 
    TogglePath.BackgroundColor3 = CONFIG.showPath and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(170, 0, 0)
    TogglePath.Text = "Petunjuk CP: " .. (CONFIG.showPath and "ON" or "OFF")
    TogglePath.TextColor3 = Color3.fromRGB(255, 255, 255)
    TogglePath.Font = Enum.Font.Gotham
    TogglePath.TextSize = 14
    TogglePath.Parent = Frame

    local PathCorner = Instance.new("UICorner")
    PathCorner.CornerRadius = UDim.new(0, 5)
    PathCorner.Parent = TogglePath
    
    local ToggleRaycast = Instance.new("TextButton")
    ToggleRaycast.Size = UDim2.new(0.9, 0, 0, 30)
    ToggleRaycast.Position = UDim2.new(0.05, 0, 0, 215)
    ToggleRaycast.BackgroundColor3 = CONFIG.showRaycast and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(170, 0, 0)
    ToggleRaycast.Text = "Sonar Labirin: " .. (CONFIG.showRaycast and "ON" or "OFF")
    ToggleRaycast.TextColor3 = Color3.fromRGB(255, 255, 255)
    ToggleRaycast.Font = Enum.Font.Gotham
    ToggleRaycast.TextSize = 14
    ToggleRaycast.Parent = Frame

    local RaycastCorner = Instance.new("UICorner")
    RaycastCorner.CornerRadius = UDim.new(0, 5)
    RaycastCorner.Parent = ToggleRaycast

    local minimizableElements = {CPInfo, PrevCP, NextCP, ToggleESP, TogglePath, ToggleRaycast}
    local isMinimized = false
    local originalFrameSize = Frame.Size
    local minimizedFrameSize = UDim2.new(originalFrameSize.X.Scale, originalFrameSize.X.Offset, 0, Title.Size.Y.Offset)

    -- === KONEKSI TOMBOL (DIBUNGKUS PCALL) ===
    
    PrevCP.MouseButton1Click:Connect(function()
        local s, e = pcall(function()
            local prevCP = getPreviousCheckpoint()
            if prevCP then
                targetCheckpoint = prevCP
                -- Set index kita ke target sebelumnya
                for i, cp in ipairs(allCheckpoints) do
                    if cp.position == prevCP.position then -- Cek by posisi
                        currentCheckpointIndex = i
                        break
                    end
                end
                print("Target diubah manual ke (Prev) Checkpoint " .. targetCheckpoint.number)
                updateCPInfo()
            end
        end)
        if not s then warn("Error PrevCP:", e) end
    end)

    NextCP.MouseButton1Click:Connect(function()
        local s, e = pcall(function()
            local nextCP = getNextCheckpoint()
            if nextCP then
                targetCheckpoint = nextCP
                print("Target diubah manual ke (Next) Checkpoint " .. nextCP.number)
                updateCPInfo()
            end
        end)
        if not s then warn("Error NextCP:", e) end
    end)

    ToggleESP.MouseButton1Click:Connect(function()
        -- ... (Tidak berubah) ...
        local s, e = pcall(function()
            CONFIG.showESP = not CONFIG.showESP
            ToggleESP.Text = "Deteksi Part palsu: " .. (CONFIG.showESP and "ON" or "OFF")
            ToggleESP.BackgroundColor3 = CONFIG.showESP and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(170, 0, 0)
        end)
        if not s then warn("Error ToggleESP:", e) end
    end)

    TogglePath.MouseButton1Click:Connect(function()
        -- ... (Tidak berubah) ...
        local s, e = pcall(function()
            CONFIG.showPath = not CONFIG.showPath
            TogglePath.Text = "Petunjuk CP: " .. (CONFIG.showPath and "ON" or "OFF")
            TogglePath.BackgroundColor3 = CONFIG.showPath and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(170, 0, 0)
        end)
        if not s then warn("Error TogglePath:", e) end
    end)
    
    ToggleRaycast.MouseButton1Click:Connect(function()
        -- ... (Tidak berubah) ...
        local s, e = pcall(function()
            CONFIG.showRaycast = not CONFIG.showRaycast
            ToggleRaycast.Text = "Sonar Labirin: " .. (CONFIG.showRaycast and "ON" or "OFF")
            ToggleRaycast.BackgroundColor3 = CONFIG.showRaycast and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(170, 0, 0)
            
            if not CONFIG.showRaycast then
                clearRaycastVisuals()
            end
        end)
        if not s then warn("Error ToggleRaycast:", e) end
    end)
    
    MinimizeButton.MouseButton1Click:Connect(function()
        -- ... (Tidak berubah) ...
        isMinimized = not isMinimized
        
        for _, elem in pairs(minimizableElements) do
            elem.Visible = not isMinimized
        end
        
        if isMinimized then
            Frame.Size = minimizedFrameSize
            MinimizeButton.Text = "+"
        else
            Frame.Size = originalFrameSize
            MinimizeButton.Text = "—"
        end
    end)
    
    CloseButton.MouseButton1Click:Connect(function()
        local s, e = pcall(function()
            print("Menutup Path Finder...")
            if heartbeatConnection then
                heartbeatConnection:Disconnect()
                heartbeatConnection = nil
            end
            if charAddedConnection then
                charAddedConnection:Disconnect()
                charAddedConnection = nil
            end
            clearESP()
            clearPath()
            clearRaycastVisuals()
            ScreenGui:Destroy()
            print("Path Finder Dimatikan.")
        end)
        if not s then warn("Error CloseButton:", e) end
    end)
end)

if not guiSuccess then
    warn("GAGAL MEMBUAT GUI:", guiError)
end

-- === INISIALISASI & MAIN LOOP ===
print("=== Path Finder & Fake Part Detector Activated (v10 Streaming Fix) ===")

local function onCharacterAdded(newChar)
    local s, e = pcall(function()
        character = newChar
        humanoidRootPart = newChar:WaitForChild("HumanoidRootPart")
        clearESP()
        clearPath()
        clearRaycastVisuals()
        wait(1)
        print("Character respawned. Discovering CPs and syncing...")
        
        discoverCheckpoints() -- Cari CP di sekitar area spawn
        findCurrentCheckpoint() -- Sinkronisasi index (tidak akan mundur)
        targetCheckpoint = getNextCheckpoint() 
        updateCPInfo()
    end)
    if not s then warn("CharacterAdded Error:", e) end
end

charAddedConnection = player.CharacterAdded:Connect(onCharacterAdded)
if character then
    onCharacterAdded(character)
end

local initSuccess, initError = pcall(function()
    wait(2) 
    print("Initial checkpoint discovery...")
    discoverCheckpoints() 
    findCurrentCheckpoint() 
    targetCheckpoint = getNextCheckpoint() 
    updateCPInfo()
    if targetCheckpoint then
        print("Initial Target: Checkpoint " .. targetCheckpoint.number)
    else
        print("No target checkpoint found on init. Waiting for CPs to load...")
    end
end)

if not initSuccess then
    warn("Failed to initialize checkpoints:", initError)
end

-- === MAIN LOOP (DIBUNGKUS PCALL) ===
local lastUpdate = 0
local lastCheckpointScan = 0

heartbeatConnection = RunService.Heartbeat:Connect(function()
    local s, e = pcall(function()
        local currentTime = tick()
        
        -- Loop Cepat (ESP & Path & Raycast & Auto-Next)
        if currentTime - lastUpdate >= CONFIG.updateInterval then
            lastUpdate = currentTime
            if humanoidRootPart and humanoidRootPart.Parent then
                scanEnvironment() 
                updateCPInfo() 
            elseif not humanoidRootPart and player.Character then
                humanoidRootPart = player.Character:FindFirstChild("HumanoidRootPart")
            end
        end
        
        -- Loop Lambat (Discover Checkpoint & Sinkronisasi)
        if currentTime - lastCheckpointScan >= CONFIG.checkpointScanInterval then
            lastCheckpointScan = currentTime
            
            discoverCheckpoints() -- Cari CP baru yang mungkin baru dimuat
            findCurrentCheckpoint() -- Sinkronisasi index (jika kita maju)
            
            -- Jika target kita tidak valid (mungkin baru mulai), cari target
            if not (targetCheckpoint and targetCheckpoint.position) then
                targetCheckpoint = getNextCheckpoint()
            end
        end
    end)
    
    if not s then
        warn("Heartbeat Error:", e)
    end
end)

