-- =========================================================
-- ==    SKRIP EXECUTOR DETEKTOR & ADMIN GUI v4.2         ==
-- ==    (Visual Aktif, GUI Tersembunyi)                  ==
-- ==    ✅ DIPERBAIKI: DisplayName Tidak Muncul          ==
-- ==    ✅ DIOPTIMALKAN: Tidak Lag, Tidak Overhead       ==
-- =========================================================

-- ===============================================
-- ==  BAGIAN 0: PENCEGAH SKRIP GANDA (ANTI-LAG)  ==
-- ===============================================
if getgenv()._RistanBanSystem_V3 then
    print("Skrip lama terdeteksi (v4.2). Menghancurkan...")
    if getgenv()._RistanBanSystem_V3.Destroy then
        getgenv()._RistanBanSystem_V3:Destroy()
    end
end

-- ===============================================
-- ==          BAGIAN 1: LAYANAN & KONFIGURASI    ==
-- ===============================================

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")
local UserService = game:GetService("UserService")
local LocalPlayer = Players.LocalPlayer

local Connections = {}
local isScriptDestroyed = false

-- KONFIGURASI SERVER (VERCEL)
local VERCEL_BASE_URL = "https://roblox-ban-list.vercel.app"
local VERCEL_BAN_LIST_URL = VERCEL_BASE_URL .. "/ban-list"
local VERCEL_SECRET_KEY = "limamar123"

-- KONFIGURASI VISUAL
local CONFIG = {
    DetectionDistance = 20,
    VisualDistance = 50,
    CheckInterval = 5,
    MarkerColor = Color3.fromRGB(255, 0, 0),
    SoundId = "rbxassetid://9125402735",
    SoundVolume = 1,
    BlinkSpeed = 1.4,
    GuiTransitionTime = 0.2
}

-- ===============================================
-- ==        BAGIAN 2: LOGIKA INTI & BACKEND      ==
-- ===============================================

local BlockedUserIds = {}
local PlayerVisuals = {}
local PlayerGuiCache = {}

local function isBlocked(player)
    if not player then return false end
    return BlockedUserIds[tostring(player.UserId)] == true
end

-- ---------------------------------
-- FUNGSI VISUAL
-- ---------------------------------
local function removeVisuals(character)
    if not character or not PlayerVisuals[character] then return end
    local visuals = PlayerVisuals[character]
    if visuals.Billboard and visuals.Billboard.Parent then visuals.Billboard:Destroy() end
    if visuals.BlinkConnection then visuals.BlinkConnection:Disconnect() end
    if visuals.DiedConnection then visuals.DiedConnection:Disconnect() end
    PlayerVisuals[character] = nil
end

local function createVisuals(character)
    if not character or PlayerVisuals[character] then return end
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    local head = character:FindFirstChild("Head")
    if not humanoidRootPart or not head then return end

    local visuals = {}

    local billboard = Instance.new("BillboardGui")
    billboard.Name = "BlockedIndicator"
    billboard.Size = UDim2.new(0, 100, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = head
    visuals.Billboard = billboard

    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = "⚠️ DIBLOKIR"
    textLabel.TextColor3 = CONFIG.MarkerColor
    textLabel.TextScaled = true
    textLabel.Font = Enum.Font.GothamBold
    textLabel.TextStrokeTransparency = 0
    textLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
    textLabel.Parent = billboard

    local lastBeat = tick()
    local connection = RunService.Heartbeat:Connect(function()
        if not textLabel.Parent then
            connection:Disconnect()
            return
        end
        local currentTime = tick()
        if currentTime - lastBeat >= CONFIG.BlinkSpeed then
            local targetTransparency = textLabel.TextTransparency > 0.5 and 0 or 1
            local tween = TweenService:Create(textLabel, TweenInfo.new(CONFIG.BlinkSpeed / 2), {
                TextTransparency = targetTransparency,
                TextStrokeTransparency = targetTransparency
            })
            tween:Play()
            lastBeat = currentTime
        end
    end)
    visuals.BlinkConnection = connection
    table.insert(Connections, connection)

    PlayerVisuals[character] = visuals
end

-- ---------------------------------
-- FUNGSI JARINGAN
-- ---------------------------------
local function sendVercelRequest(endpoint, payload, button, successMessage, failMessage)
    local url = VERCEL_BASE_URL .. endpoint
    local body = HttpService:JSONEncode(payload)
    local headers = {
        ["Content-Type"] = "application/json",
        ["X-Roblox-Secret"] = VERCEL_SECRET_KEY
    }

    task.spawn(function()
        if isScriptDestroyed then return end
        local successPost, responseOrError = pcall(function()
            if request then
                return request({ Url = url, Method = "POST", Headers = headers, Body = body })
            else
                return HttpService:RequestAsync({ Url = url, Method = "POST", Headers = headers, Body = body })
            end
        end)

        if not successPost or isScriptDestroyed then
            if button then
                button.Text = "ERROR"
                task.wait(2)
                button.Text = endpoint:find("ban") and "Ban" or "Unban"
                button.Active = true
            end
            return
        end

        local responsePost = responseOrError
        local isSuccess = (responsePost.Success == true) or (responsePost.StatusCode == 200)

        if isSuccess then
            if button then
                button.Text = successMessage
                button.Active = false
                task.wait(2)
                button.Text = endpoint:find("ban") and "Ban" or "Unban"
                button.Active = true
            end

            task.wait(1)
            fetchBanList(function()
                updatePlayerListGui()
                for _, p in ipairs(Players:GetPlayers()) do
                    handlePlayer(p)
                end
            end)
        else
            local msg = failMessage
            if responsePost.StatusCode == 400 then
                msg = "ERROR: Kurang Data"
            end
            if button then
                button.Text = msg
                button.Active = false
                task.wait(2)
                button.Text = endpoint:find("ban") and "Ban" or "Unban"
                button.Active = true
            end
        end
    end)
end

local function sendBanRequest(playerToBan, banButton)
    if not playerToBan then return end
    BlockedUserIds[tostring(playerToBan.UserId)] = true
    handlePlayer(playerToBan)
    updatePlayerListGui()

    sendVercelRequest("/ban-player", {
        username = playerToBan.Name,
        userId = playerToBan.UserId,
        displayName = playerToBan.DisplayName or playerToBan.Name
    }, banButton, "Ban Berhasil!", "Gagal")
end

local function sendUnbanRequest(playerToUnban, unbanButton)
    if not playerToUnban then return end
    BlockedUserIds[tostring(playerToUnunban.UserId)] = nil
    handlePlayer(playerToUnban)
    updatePlayerListGui()

    sendVercelRequest("/unban-player", {
        username = playerToUnban.Name,
        userId = playerToUnban.UserId
    }, unbanButton, "Unban Berhasil!", "Gagal")
end

-- ---------------------------------
-- MUAT DAFTAR BLOKIR DARI SERVER
-- ---------------------------------
local function fetchBanList(onCompleteCallback)
    task.spawn(function()
        if isScriptDestroyed then return end
        local successRequest, responseOrError = pcall(function()
            local headers = { ["X-Roblox-Secret"] = VERCEL_SECRET_KEY }
            if request then
                return request({ Url = VERCEL_BAN_LIST_URL, Method = "GET", Headers = headers })
            else
                return HttpService:RequestAsync({ Url = VERCEL_BAN_LIST_URL, Method = "GET", Headers = headers })
            end
        end)

        if not successRequest or isScriptDestroyed then return end

        local response = responseOrError
        if response.Success and response.StatusCode == 200 then
            local successJson, data = pcall(HttpService.JSONDecode, HttpService, response.Body)
            if successJson and data and data.status == "success" and data.banned_users then
                local newBanList = {}
                for userId, _ in pairs(data.banned_users) do
                    newBanList[tostring(userId)] = true
                end
                BlockedUserIds = newBanList
                if onCompleteCallback then onCompleteCallback() end
            end
        end
    end)
end

-- ---------------------------------
-- PENGELOLA PEMAIN
-- ---------------------------------
function handlePlayer(player)
    if player == LocalPlayer then return end
    if not isBlocked(player) then
        if player.Character then
            removeVisuals(player.Character)
        end
    end
end

-- ===============================================
-- ==         BAGIAN 3: SISTEM GUI (TETAP SAMA)   ==
-- ===============================================

local BanGui = {
    ScreenGui = nil,
    MainFrame = nil,
    PlayerListFrame = nil,
    ToggleButton = nil,
    SearchBox = nil,
    ManualBanFrame = nil
}

local function animateGui(toHide, toShow)
    local hideList = type(toHide) == "table" and toHide or {toHide}
    local showList = type(toShow) == "table" and toShow or {toShow}
    for _, item in ipairs(hideList) do
        if item and item.Parent then item.Visible = false end
    end
    for _, item in ipairs(showList) do
        if item and item.Parent then item.Visible = true end
    end
end

function updatePlayerListGui()
    if isScriptDestroyed or not BanGui.PlayerListFrame then return end
    local list = BanGui.PlayerListFrame
    local filterText = (BanGui.SearchBox and BanGui.SearchBox.Text:lower()) or ""
    local playersInServer = {}

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local nameMatch = player.Name:lower():find(filterText, 1, true)
            local displayNameMatch = (player.DisplayName or player.Name):lower():find(filterText, 1, true)
            if filterText == "" or nameMatch or displayNameMatch then
                table.insert(playersInServer, player)
            end
        end
    end

    table.sort(playersInServer, function(a, b) return a.Name < b.Name end)

    local frameHeight = 30
    local padding = 5
    local playersToKeep = {}

    for i, player in ipairs(playersInServer) do
        local userIdStr = tostring(player.UserId)
        local playerFrame = PlayerGuiCache[userIdStr]

        if not playerFrame or not playerFrame.Parent then
            playerFrame = Instance.new("Frame")
            playerFrame.Name = "PlayerFrame_" .. player.Name
            playerFrame.Size = UDim2.new(1, 0, 0, frameHeight)
            playerFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
            playerFrame.Parent = list
            PlayerGuiCache[userIdStr] = playerFrame

            local nameLabel = Instance.new("TextLabel")
            nameLabel.Size = UDim2.new(0.7, -5, 1, 0)
            nameLabel.TextXAlignment = Enum.TextXAlignment.Left
            nameLabel.BackgroundTransparency = 1
            nameLabel.Position = UDim2.new(0, 5, 0, 0)
            nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
            nameLabel.Parent = playerFrame

            local actionButton = Instance.new("TextButton")
            actionButton.Size = UDim2.new(0.3, 0, 1, 0)
            actionButton.Position = UDim2.new(0.7, 0, 0, 0)
            actionButton.TextColor3 = Color3.fromRGB(255, 255, 255)
            actionButton.Font = Enum.Font.GothamBold
            actionButton.Parent = playerFrame

            actionButton.MouseButton1Click:Connect(function()
                actionButton.Text = "..."
                actionButton.Active = false
                if isBlocked(player) then
                    sendUnbanRequest(player, actionButton)
                else
                    sendBanRequest(player, actionButton)
                end
            end)
        end

        table.insert(playersToKeep, userIdStr)
        playerFrame.LayoutOrder = i

        local nameLabel = playerFrame:FindFirstChild("NameLabel")
        local actionButton = playerFrame:FindFirstChild("ActionButton")

        if nameLabel then
            nameLabel.Text = (player.DisplayName or player.Name) .. " (@" .. player.Name .. ")"
        end

        if actionButton then
            local blocked = isBlocked(player)
            actionButton.Text = blocked and "UNBAN" or "BAN"
            actionButton.BackgroundColor3 = blocked and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
            actionButton.Active = true
        end
    end

    for userId, frame in pairs(PlayerGuiCache) do
        if not table.find(playersToKeep, userId) and frame.Parent == list then
            frame:Destroy()
            PlayerGuiCache[userId] = nil
        end
    end

    local layout = list:FindFirstChildOfClass("UIListLayout")
    if not layout then
        layout = Instance.new("UIListLayout")
        layout.Padding = UDim.new(0, padding)
        layout.SortOrder = Enum.SortOrder.LayoutOrder
        layout.Parent = list
    end

    local num = #playersInServer
    local totalHeight = num > 0 and (num * frameHeight + (num - 1) * padding + 10) or 0
    list.CanvasSize = UDim2.new(0, 0, 0, totalHeight)
end

local function destroyScript()
    isScriptDestroyed = true
    for _, conn in ipairs(Connections) do
        pcall(function() conn:Disconnect() end)
    end
    Connections = {}
    for char in pairs(PlayerVisuals) do
        removeVisuals(char)
    end
    PlayerVisuals = {}
    for _, frame in pairs(PlayerGuiCache) do
        if frame.Parent then frame:Destroy() end
    end
    PlayerGuiCache = {}
    if BanGui.ScreenGui then BanGui.ScreenGui:Destroy() end
    getgenv()._RistanBanSystem_V3 = nil
    getgenv()._RistanShowPanel = nil
end

local function createBanGui()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "_RistanBanSystemGUI"
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Global
    screenGui.ResetOnSpawn = false
    screenGui.Parent = CoreGui
    BanGui.ScreenGui = screenGui

    local function showAdminPanel()
        if BanGui.MainFrame then
            BanGui.MainFrame.Visible = true
            updatePlayerListGui()
            animateGui(BanGui.ManualBanFrame, {BanGui.PlayerListFrame, BanGui.SearchBox, BanGui.MainFrame:FindFirstChild("ManualBanButton")})
            local title = BanGui.MainFrame:FindFirstChild("TextLabel")
            if title then title.Text = "Daftar Pemain" end
        end
        if BanGui.ToggleButton then BanGui.ToggleButton.Visible = true end
    end

    getgenv()._RistanShowPanel = showAdminPanel
    getgenv()._RistanBanSystem_V3 = { Destroy = destroyScript, ShowPanel = showAdminPanel }

    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 280, 0, 280)
    mainFrame.Position = UDim2.new(0.5, -140, 0.5, -140)
    mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    mainFrame.Visible = false
    mainFrame.Active = true
    mainFrame.Draggable = true
    mainFrame.Parent = screenGui
    BanGui.MainFrame = mainFrame

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Name = "TextLabel"
    titleLabel.Size = UDim2.new(1, 0, 0, 30)
    titleLabel.Text = "Daftar Pemain"
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = 15
    titleLabel.Parent = mainFrame

    -- Tombol SEMBUNYIKAN
    local closeButton = Instance.new("TextButton")
    closeButton.Size = UDim2.new(0, 80, 0, 22)
    closeButton.Position = UDim2.new(1, -85, 0.5, -11)
    closeButton.Text = "Sembunyikan"
    closeButton.TextSize = 10
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    closeButton.Font = Enum.Font.GothamBold
    closeButton.Parent = titleLabel
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 4)
    closeCorner.Parent = closeButton
    table.insert(Connections, closeButton.MouseButton1Click:Connect(function()
        mainFrame.Visible = false
        if BanGui.ToggleButton then BanGui.ToggleButton.Visible = false end
    end))

    -- Tombol MATIKAN
    local masterCloseButton = Instance.new("TextButton")
    masterCloseButton.Size = UDim2.new(0, 60, 0, 22)
    masterCloseButton.Position = UDim2.new(0, 5, 0.5, -11)
    masterCloseButton.Text = "Matikan"
    masterCloseButton.TextSize = 10
    masterCloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    masterCloseButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    masterCloseButton.Font = Enum.Font.GothamBold
    masterCloseButton.Parent = titleLabel
    local masterCloseCorner = Instance.new("UICorner")
    masterCloseCorner.CornerRadius = UDim.new(0, 4)
    masterCloseCorner.Parent = masterCloseButton
    table.insert(Connections, masterCloseButton.MouseButton1Click:Connect(destroyScript))

    -- Search Box
    local searchBox = Instance.new("TextBox")
    searchBox.Name = "SearchBox"
    searchBox.Size = UDim2.new(1, -10, 0, 30)
    searchBox.Position = UDim2.new(0, 5, 0, 35)
    searchBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    searchBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    searchBox.PlaceholderText = "Cari nama pemain..."
    searchBox.ClearTextOnFocus = false
    searchBox.Text = ""
    searchBox.Parent = mainFrame
    BanGui.SearchBox = searchBox
    table.insert(Connections, searchBox:GetPropertyChangedSignal("Text"):Connect(updatePlayerListGui))

    -- Player List
    local playerList = Instance.new("ScrollingFrame")
    playerList.Name = "PlayerList"
    playerList.Size = UDim2.new(1, -10, 1, -105)
    playerList.Position = UDim2.new(0, 5, 0, 70)
    playerList.BackgroundTransparency = 1
    playerList.CanvasSize = UDim2.new(0, 0, 0, 0)
    playerList.ScrollBarImageColor3 = Color3.fromRGB(255, 255, 255)
    playerList.Parent = mainFrame
    BanGui.PlayerListFrame = playerList

    -- Manual Ban Button
    local manualBanButton = Instance.new("TextButton")
    manualBanButton.Name = "ManualBanButton"
    manualBanButton.Size = UDim2.new(1, -10, 0, 30)
    manualBanButton.Position = UDim2.new(0, 5, 1, -35)
    manualBanButton.Text = "Ban Manual"
    manualBanButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    manualBanButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    manualBanButton.Font = Enum.Font.GothamBold
    manualBanButton.TextSize = 15
    manualBanButton.Parent = mainFrame

    -- Manual Ban Frame
    local manualBanFrame = Instance.new("Frame")
    manualBanFrame.Name = "ManualBanFrame"
    manualBanFrame.Size = UDim2.new(1, 0, 1, -30)
    manualBanFrame.Position = UDim2.new(0, 0, 0, 30)
    manualBanFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    manualBanFrame.Visible = false
    manualBanFrame.Parent = mainFrame
    BanGui.ManualBanFrame = manualBanFrame

    local dynamicLabel = Instance.new("TextLabel")
    dynamicLabel.Size = UDim2.new(1, 0, 0, 30)
    dynamicLabel.Position = UDim2.new(0, 0, 0, 10)
    dynamicLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    dynamicLabel.BackgroundTransparency = 1
    dynamicLabel.Font = Enum.Font.GothamBold
    dynamicLabel.Text = "Masukkan Nama atau ID Pemain"
    dynamicLabel.TextTransparency = 0.5
    dynamicLabel.Parent = manualBanFrame

    local usernameInput = Instance.new("TextBox")
    usernameInput.Size = UDim2.new(1, -20, 0, 30)
    usernameInput.Position = UDim2.new(0, 10, 0, 50)
    usernameInput.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    usernameInput.TextColor3 = Color3.fromRGB(255, 255, 255)
    usernameInput.PlaceholderText = "Ketik di sini..."
    usernameInput.ClearTextOnFocus = false
    usernameInput.TextXAlignment = Enum.TextXAlignment.Center
    usernameInput.Parent = manualBanFrame

    table.insert(Connections, usernameInput:GetPropertyChangedSignal("Text"):Connect(function()
        local text = usernameInput.Text:gsub("%s", "")
        if text == "" then
            dynamicLabel.Text = "Masukkan Nama atau ID Pemain"
            dynamicLabel.TextTransparency = 0.5
        else
            dynamicLabel.Text = usernameInput.Text
            dynamicLabel.TextTransparency = 0
        end
    end))

    local banBtn = Instance.new("TextButton")
    banBtn.Size = UDim2.new(0.5, -15, 0, 40)
    banBtn.Position = UDim2.new(0, 10, 0, 90)
    banBtn.Text = "Ban"
    banBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    banBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    banBtn.Font = Enum.Font.GothamBold
    banBtn.TextSize = 10
    banBtn.Parent = manualBanFrame

    local unbanBtn = Instance.new("TextButton")
    unbanBtn.Size = UDim2.new(0.5, -15, 0, 40)
    unbanBtn.Position = UDim2.new(0.5, 5, 0, 90)
    unbanBtn.Text = "Unban"
    unbanBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    unbanBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
    unbanBtn.Font = Enum.Font.GothamBold
    unbanBtn.TextSize = 10
    unbanBtn.Parent = manualBanFrame

    local backBtn = Instance.new("TextButton")
    backBtn.Size = UDim2.new(1, -20, 0, 30)
    backBtn.Position = UDim2.new(0, 10, 0, 140)
    backBtn.Text = "<- Kembali ke Daftar"
    backBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    backBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    backBtn.Font = Enum.Font.GothamBold
    backBtn.TextSize = 13
    backBtn.Parent = manualBanFrame

    table.insert(Connections, manualBanButton.MouseButton1Click:Connect(function()
        animateGui({BanGui.PlayerListFrame, BanGui.SearchBox, manualBanButton}, manualBanFrame)
        titleLabel.Text = "Ban Manual"
        usernameInput.Text = ""
        dynamicLabel.Text = "Masukkan Nama atau ID Pemain"
        dynamicLabel.TextTransparency = 0.5
    end))

    table.insert(Connections, backBtn.MouseButton1Click:Connect(function()
        animateGui(manualBanFrame, {BanGui.PlayerListFrame, BanGui.SearchBox, manualBanButton})
        titleLabel.Text = "Daftar Pemain"
        banBtn.Text = "Ban"; banBtn.Active = true
        unbanBtn.Text = "Unban"; unbanBtn.Active = true
    end))

    local function handleManual(action)
        local input = usernameInput.Text:gsub("%s", "")
        local btn = action == "ban" and banBtn or unbanBtn
        if input == "" then
            btn.Text = "Kosong!"
            task.wait(2)
            btn.Text = action == "ban" and "Ban" or "Unban"
            return
        end

        btn.Text = "..."
        btn.Active = false

        task.spawn(function()
            local userId, username, displayName

            local playerInGame = Players:GetPlayerByUserId(tonumber(input)) or Players:FindFirstChild(input)
            if playerInGame then
                userId = playerInGame.UserId
                username = playerInGame.Name
                displayName = playerInGame.DisplayName or username
            else
                local ok, id = pcall(function() return Players:GetUserIdFromNameAsync(input) end)
                if ok and id then
                    userId = id
                    local ok2, info = pcall(function() return UserService:GetUserInfosByUserIdsAsync({userId}) end)
                    if ok2 and info[1] then
                        username = info[1].Username or input
                        displayName = info[1].DisplayName or username
                    else
                        btn.Text = "Tidak Ditemukan!"
                        task.wait(2)
                        btn.Text = action == "ban" and "Ban" or "Unban"
                        btn.Active = true
                        return
                    end
                else
                    btn.Text = "Tidak Ditemukan!"
                    task.wait(2)
                    btn.Text = action == "ban" and "Ban" or "Unban"
                    btn.Active = true
                    return
                end
            end

            local dummy = { UserId = userId, Name = username, DisplayName = displayName }
            if action == "ban" then
                sendBanRequest(dummy, banBtn)
            else
                sendUnbanRequest(dummy, unbanBtn)
            end
        end)
    end

    table.insert(Connections, banBtn.MouseButton1Click:Connect(function() handleManual("ban") end))
    table.insert(Connections, unbanBtn.MouseButton1Click:Connect(function() handleManual("unban") end))

    -- Toggle Button
    local toggleButton = Instance.new("TextButton")
    toggleButton.Size = UDim2.new(0, 100, 0, 30)
    toggleButton.Position = UDim2.new(0, 154, 0, 132)
    toggleButton.Text = "Ban Panel"
    toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    toggleButton.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
    toggleButton.Font = Enum.Font.GothamBold
    toggleButton.Visible = false
    toggleButton.TextSize = 13
    toggleButton.Parent = screenGui
    BanGui.ToggleButton = toggleButton

    table.insert(Connections, toggleButton.MouseButton1Click:Connect(function()
        if BanGui.MainFrame then
            BanGui.MainFrame.Visible = not BanGui.MainFrame.Visible
            if BanGui.MainFrame.Visible then
                updatePlayerListGui()
                animateGui(BanGui.ManualBanFrame, {BanGui.PlayerListFrame, BanGui.SearchBox, manualBanButton})
                titleLabel.Text = "Daftar Pemain"
            end
        end
    end))

    print("✅ GUI Ban Panel v4.2 (Optimized) berhasil dibuat.")
end

-- ===============================================
-- ==      BAGIAN 4: PENGELOLA & INISIALISASI   ==
-- ===============================================

local soundPlayed = {} -- ✅ TRACK SUARA PER USER ID

local function checkDistance()
    if isScriptDestroyed then return end
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return end
    local localHRP = LocalPlayer.Character.HumanoidRootPart
    local soundDist = CONFIG.DetectionDistance
    local visualDist = CONFIG.VisualDistance

    for _, player in ipairs(Players:GetPlayers()) do
        if player == LocalPlayer or not player.Character then continue end
        local targetHRP = player.Character:FindFirstChild("HumanoidRootPart")
        if not targetHRP then continue end

        local distance = (localHRP.Position - targetHRP.Position).Magnitude
        local character = player.Character
        local isPBlocked = isBlocked(player)
        local userIdStr = tostring(player.UserId)

        if isPBlocked then
            -- VISUAL
            if distance <= visualDist then
                if not PlayerVisuals[character] then
                    createVisuals(character)
                    local diedConn = player.Character.Humanoid.Died:Connect(function()
                        removeVisuals(character)
                    end)
                    PlayerVisuals[character].DiedConnection = diedConn
                    table.insert(Connections, diedConn)
                end
            else
                if PlayerVisuals[character] then
                    removeVisuals(character)
                end
            end

            -- SUARA: hanya sekali per masuk jarak
            if distance <= soundDist then
                if not soundPlayed[userIdStr] then
                    soundPlayed[userIdStr] = true
                    local sound = Instance.new("Sound")
                    sound.SoundId = CONFIG.SoundId
                    sound.Volume = CONFIG.SoundVolume
                    sound.Looped = false
                    sound.Parent = targetHRP
                    task.spawn(function()
                        if pcall(function() sound.Loaded:Wait(3) end) and sound.Parent then
                            sound:Play()
                            task.wait(sound.TimeLength or 2)
                        end
                        if sound.Parent then sound:Destroy() end
                    end)
                end
            else
                soundPlayed[userIdStr] = nil -- reset saat keluar jarak
            end
        else
            if PlayerVisuals[character] then
                removeVisuals(character)
            end
        end
    end
end

local function checkAllPlayers()
    for _, player in ipairs(Players:GetPlayers()) do
        handlePlayer(player)
    end
    checkDistance()
end

local function setupDisplayNameTracking()
    local function connect(player)
        if player ~= LocalPlayer then
            table.insert(Connections, player:GetPropertyChangedSignal("DisplayName"):Connect(updatePlayerListGui))
        end
    end
    for _, p in ipairs(Players:GetPlayers()) do connect(p) end
    table.insert(Connections, Players.PlayerAdded:Connect(connect))
end

-- Player Added/Removed
table.insert(Connections, Players.PlayerAdded:Connect(function(player)
    task.delay(1, function()
        if not isScriptDestroyed then
            handlePlayer(player)
            updatePlayerListGui()
        end
    end)
end))

table.insert(Connections, Players.PlayerRemoving:Connect(function(player)
    if player.Character then removeVisuals(player.Character) end
    local id = tostring(player.UserId)
    PlayerGuiCache[id] = nil
    soundPlayed[id] = nil
    updatePlayerListGui()
end))

-- ✅ LOOP JARAK OPTIMAL (tidak pakai Heartbeat!)
task.spawn(function()
    while not isScriptDestroyed do
        checkDistance()
        task.wait(CONFIG.CheckInterval)
    end
end)

-- ===============================================
-- ==         MEMULAI SKRIP                      ==
-- ===============================================
createBanGui()
setupDisplayNameTracking()

fetchBanList(function()
    print("✅ Daftar blokir dimuat. Memeriksa pemain...")
    checkAllPlayers()
    updatePlayerListGui()
end)

-- Refresh tiap 5 menit
task.spawn(function()
    while not isScriptDestroyed do
        task.wait(300)
        if not isScriptDestroyed then
            fetchBanList(function()
                checkAllPlayers()
                updatePlayerListGui()
            end)
        end
    end
end)

print("✅ Blocked Player Detector & Admin GUI v4.2 (Optimized + Fix DisplayName) Active!")
